<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماشین حساب رژیم (طراحی واکنش‌گرا)</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; scroll-behavior: smooth; }
        .meal-card, .fixed-item-card { transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; border-width: 2px; border-color: transparent; }
        .meal-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); }
        .meal-card.selected { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .satiety-card { border-left-width: 4px; border-left-color: #f59e0b; }
        .ingredient-list { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .meal-card.open .ingredient-list, .fixed-item-card.open .ingredient-list { max-height: 1500px; }
        .sticky-summary { position: -webkit-sticky; position: sticky; top: 1rem; z-index: 10; }
        .keto-tag { background-color: #16a34a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 10px; }
        .gram-input { width: 60px; text-align: center; border: 1px solid #d1d5db; border-radius: 6px; padding: 2px 4px; margin-left: 4px; }
        .calorie-input { width: 70px; text-align: center; border: 1px solid #d1d5db; border-radius: 6px; padding: 2px 4px; font-weight: bold; }
        .toggle-label { background-color: #f87171; transition: background-color 0.2s ease; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4ade80; }
        .toggle-checkbox:checked + .toggle-label .toggle-dot { transform: translateX(100%); }
        .lock-icon { cursor: pointer; opacity: 0.4; transition: opacity 0.2s, color 0.2s; }
        .lock-icon.locked { opacity: 1.0; color: #3b82f6; }
        .ingredient-macros { font-size: 0.75rem; color: #6b7280; min-width: 170px; text-align: right; white-space: nowrap; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
    <header class="text-center mb-6 md:mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">🥗 ماشین حساب ضد گرسنگی</h1>
        <p class="text-md md:text-lg text-gray-600">طراحی واکنش‌گرا برای تمام دستگاه‌ها</p>
    </header>

    <!-- User Inputs -->
    <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6 md:mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 no-print">
        <div>
            <label for="currentWeight" class="block text-center font-semibold text-gray-700 mb-2">⚖️ وزن فعلی (کیلوگرم)</label>
            <input type="number" id="currentWeight" value="93" class="w-full p-3 border-2 rounded-lg text-xl text-center font-semibold text-blue-600 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label for="targetWeeklyLoss" class="block text-center font-semibold text-gray-700 mb-2">📉 هدف کاهش هفتگی (کیلوگرم)</label>
            <input type="number" id="targetWeeklyLoss" value="1.0" step="0.1" class="w-full p-3 border-2 rounded-lg text-xl text-center font-semibold text-green-600 focus:ring-green-500 focus:border-green-500">
        </div>
    </div>

    <!-- Live Dashboard -->
    <div id="live-dashboard" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4 mb-6 md:mb-8 text-center"></div>

    <!-- Daily Summary Bar -->
    <div id="summary-bar" class="sticky-summary bg-blue-600 text-white p-4 rounded-xl shadow-lg mb-6 md:mb-8 no-print"></div>

    <!-- Main Application Container -->
    <main id="app-container"></main>
    
    <!-- Daily Nutrition Summary Panel -->
    <section id="daily-summary-section" class="mt-8 no-print"></section>

</div>

<script>
// ===================================================================================
//  FINAL REFACTORED APP MODULE (Professional Modular Approach)
// ===================================================================================
const App = (() => {

    const DB = {
        fixedSnacks: [ { name: 'میکس تخم شربتی', id: 'fs_0', emoji: '🌱', ingredients: [{ id: 'fs_0_0', e: '🌱', n: 'تخم شربتی', g: 40, cal: 194, p: 6.9, f: 12.3, c: 16.9, fi: 13.8 }] }, { name: 'شیر کاکائو', id: 'fs_1', emoji: '🍫', ingredients: [{ id: 'fs_1_0', e: '🥛', n: 'شیر', g: 200, cal: 96, p: 7.0, f: 3.6, c: 9.6, fi: 0 }, { id: 'fs_1_1', e: '🍫', n: 'پودر کاکائو', g: 20, cal: 66, p: 3.8, f: 3.1, c: 6.6, fi: 6.6 }] }, { name: 'سالاد با سس', id: 'fs_2', emoji: '🥗', ingredients: [{ id: 'fs_2_0', e: '🥗', n: 'سالاد فصل', g: 200, cal: 40, p: 2, f: 0.4, c: 9, fi: 3 }, { id: 'fs_2_1', e: '🥣', n: 'سس هزار جزیره', g: 30, cal: 121, p: 0.2, f: 11.7, c: 2.8, fi: 0 }, { id: 'fs_2_2', e: '🥛', n: 'ماست پرچرب', g: 100, cal: 95, p: 9, f: 5, c: 3, fi: 0 }] } ],
        superSatiety: [ { name: 'چلو کباب کوبیده پرچرب', id: 'ss_0', emoji: '🍢', ingredients: [{ id: 'ss_0_0', e: '🍢', n: 'کباب کوبیده (پرچرب)', g: 180, cal: 550, p: 38, f: 45, c: 5, fi: 1 }, { id: 'ss_0_1', e: '🍚', n: 'برنج (کم)', g: 150, cal: 195, p: 4, f: 0.5, c: 42, fi: 0.6 }, { id: 'ss_0_2', e: '🧈', n: 'کره', g: 20, cal: 144, p: 0.2, f: 16.2, c: 0, fi: 0 }, { id: 'ss_0_3', e: '🥗', n: 'سالاد با روغن زیتون', g: 200, cal: 150, p: 2, f: 14, c: 5, fi: 4 }] }, { name: 'کتو: سالاد الویه', id: 'ss_1', isKeto: true, emoji: '🥚', ingredients: [{ id: 'ss_1_0', e: '🥚', n: 'تخم مرغ (۳ عدد)', g: 150, cal: 233, p: 19.5, f: 16.5, c: 1.7, fi: 0 }, { id: 'ss_1_1', e: '🥣', n: 'سس مایونز پرچرب', g: 100, cal: 700, p: 1, f: 78, c: 1, fi: 0 }, { id: 'ss_1_2', e: '🐔', n: 'سینه مرغ پخته', g: 100, cal: 165, p: 31, f: 3.6, c: 0, fi: 0 }] }, { name: 'لازانیا پرچرب', id: 'ss_2', emoji: '🍝', ingredients: [{ id: 'ss_2_0', e: '🍝', n: 'ورق لازانیا', g: 100, cal: 370, p: 12, f: 3, c: 75, fi: 4 }, { id: 'ss_2_1', e: '🥩', n: 'گوشت چرخ کرده', g: 150, cal: 380, p: 25, f: 30, c: 0, fi: 0 }, { id: 'ss_2_2', e: '🧀', n: 'پنیر پیتزا', g: 150, cal: 450, p: 38, f: 30, c: 3, fi: 0 }] }, { name: 'کتو: استیک ریبای با کره', id: 'ss_3', isKeto: true, emoji: '🥩', ingredients: [{ id: 'ss_3_0', e: '🥩', n: 'استیک ریبای', g: 300, cal: 800, p: 60, f: 65, c: 0, fi: 0 }, { id: 'ss_3_1', e: '🧈', n: 'کره', g: 30, cal: 216, p: 0.3, f: 24.3, c: 0, fi: 0 }, { id: 'ss_3_2', e: '🥦', n: 'بروکلی', g: 200, cal: 70, p: 6, f: 1, c: 12, fi: 5 }] }, { name: 'دیزی سنگی', id: 'ss_4', emoji: '🏺', ingredients: [{ id: 'ss_4_0', e: '🥩', n: 'گوشت و دنبه', g: 200, cal: 600, p: 35, f: 50, c: 5, fi: 2 }, { id: 'ss_4_1', e: '🥔', n: 'سیب‌زمینی و حبوبات', g: 150, cal: 150, p: 8, f: 1, c: 30, fi: 8 }, { id: 'ss_4_2', e: '🍞', n: 'نان سنگک', g: 100, cal: 250, p: 10, f: 1.2, c: 55, fi: 7.4 }] } ],
        breakfast: [ { name: 'املت گوجه و پنیر', id: 'm1_0', emoji: '🍳', ingredients: [{ id: 'm1_0_0', e: '🍳', n: 'تخم مرغ (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm1_0_1', e: '🧀', n: 'پنیر خامه‌ای', g: 30, cal: 64, p: 1.8, f: 6.3, c: 1.1, fi: 0 }, { id: 'm1_0_2', e: '🍅', n: 'گوجه', g: 120, cal: 22, p: 1.1, f: 0.2, c: 4.7, fi: 1.4 }, { id: 'm1_0_3', e: '🧈', n: 'کره', g: 14, cal: 100, p: 0.1, f: 11.4, c: 0, fi: 0 }, { id: 'm1_0_4', e: '🍞', n: 'نان سنگک', g: 50, cal: 125, p: 5, f: 0.6, c: 27.5, fi: 3.7 }] }, { name: 'عدسی با کره', id: 'm1_1', emoji: '🥣', ingredients: [{ id: 'm1_1_0', e: '🥣', n: 'عدس پخته', g: 150, cal: 174, p: 13.5, f: 0.6, c: 30, fi: 12 }, { id: 'm1_1_1', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }, { id: 'm1_1_2', e: '🍞', n: 'نان بربری', g: 50, cal: 137, p: 4.4, f: 0.6, c: 28.1, fi: 1.2 }, { id: 'm1_1_3', e: '🧀', n: 'پنیر خامه‌ای', g: 30, cal: 64, p: 1.8, f: 6.3, c: 1.1, fi: 0 }] }, { name: 'ساندویچ رست بیف', id: 'm1_2', emoji: '🥪', ingredients: [{ id: 'm1_2_0', e: '🥩', n: 'گوشت رست بیف', g: 125, cal: 250, p: 30, f: 14, c: 0, fi: 0 }, { id: 'm1_2_1', e: '🍞', n: 'نان باگت', g: 100, cal: 280, p: 9, f: 3, c: 52, fi: 2.5 }, { id: 'm1_2_2', e: '🧀', n: 'پنیر ورقه‌ای', g: 20, cal: 70, p: 4, f: 5.5, c: 1, fi: 0 }, { id: 'm1_2_3', e: '🍄', n: 'قارچ و سس', g: 50, cal: 100, p: 2, f: 9, c: 4, fi: 1 }] }, { name: 'پنیر، گردو و خیار', id: 'm1_3', emoji: '🥒', ingredients: [{ id: 'm1_3_0', e: '🧀', n: 'پنیر خامه‌ای', g: 30, cal: 64, p: 1.8, f: 6.3, c: 1.1, fi: 0 }, { id: 'm1_3_1', e: '🌰', n: 'گردو', g: 15, cal: 98, p: 2.3, f: 9.8, c: 2.1, fi: 1 }, { id: 'm1_3_2', e: '🍞', n: 'نان لواش', g: 50, cal: 140, p: 4.4, f: 1.1, c: 28.7, fi: 1.5 }, { id: 'm1_3_3', e: '🥒', n: 'خیار', g: 150, cal: 23, p: 1, f: 0.2, c: 5.4, fi: 0.8 }, { id: 'm1_3_4', e: '🧈', n: 'کره', g: 14, cal: 100, p: 0.1, f: 11.4, c: 0, fi: 0 }] }, { name: 'چیکن برگر', id: 'm1_4', emoji: '🍔', ingredients: [{ id: 'm1_4_0', e: '🐔', n: 'سینه مرغ گریل', g: 130, cal: 215, p: 40, f: 5, c: 0, fi: 0 }, { id: 'm1_4_1', e: '🍞', n: 'نان همبرگر', g: 70, cal: 200, p: 7, f: 3, c: 36, fi: 2 }, { id: 'm1_4_2', e: '🧀', n: 'پنیر ورقه‌ای (۲)', g: 40, cal: 140, p: 8, f: 11, c: 2, fi: 0 }, { id: 'm1_4_3', e: '🥬', n: 'کاهو و گوجه', g: 50, cal: 10, p: 0.5, f: 0.1, c: 2, fi: 1 }, { id: 'm1_4_4', e: '🥣', n: 'سس', g: 30, cal: 100, p: 0.2, f: 10, c: 5, fi: 0 }] }, { name: 'تخم مرغ آب‌پز و نان', id: 'm1_5', emoji: '🥚', ingredients: [{ id: 'm1_5_0', e: '🥚', n: 'تخم مرغ آب‌پز (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm1_5_1', e: '🍞', n: 'نان سنگک', g: 50, cal: 125, p: 5, f: 0.6, c: 27.5, fi: 3.7 }, { id: 'm1_5_2', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }, { id: 'm1_5_3', e: '🥒', n: 'خیار و گوجه', g: 150, cal: 60, p: 2, f: 0.5, c: 10, fi: 2 }] }, { name: 'ماست و خیار با نان', id: 'm1_6', emoji: '🥛', ingredients: [{ id: 'm1_6_0', e: '🥛', n: 'ماست پرچرب', g: 200, cal: 190, p: 18, f: 10, c: 6, fi: 0 }, { id: 'm1_6_1', e: '🥒', n: 'خیار', g: 150, cal: 23, p: 1, f: 0.2, c: 5.4, fi: 0.8 }, { id: 'm1_6_2', e: '🌰', n: 'گردو', g: 10, cal: 65, p: 1.5, f: 6.5, c: 1.4, fi: 0.7 }, { id: 'm1_6_3', e: '🍞', n: 'نان خشک', g: 50, cal: 170, p: 5, f: 1, c: 35, fi: 3 }] }, { name: 'جو دوسر پرک', id: 'm1_7', emoji: '🥣', ingredients: [{ id: 'm1_7_0', e: '🥣', n: 'جو دوسر', g: 40, cal: 150, p: 5, f: 2.5, c: 27, fi: 4 }, { id: 'm1_7_1', e: '🌰', n: 'گردو', g: 10, cal: 65, p: 1.5, f: 6.5, c: 1.4, fi: 0.7 }, { id: 'm1_7_2', e: '🍯', n: 'عسل', g: 21, cal: 64, p: 0.1, f: 0, c: 17, fi: 0 }] }, { name: 'حلوا شکری با نان', id: 'm1_8', emoji: '🍮', ingredients: [{ id: 'm1_8_0', e: '🍮', n: 'حلوا شکری', g: 50, cal: 250, p: 7, f: 15, c: 22, fi: 2 }, { id: 'm1_8_1', e: '🍞', n: 'نان بربری', g: 50, cal: 137, p: 4.4, f: 0.6, c: 28.1, fi: 1.2 }] }, { name: 'پنکیک خانگی', id: 'm1_9', emoji: '🥞', ingredients: [{ id: 'm1_9_0', e: '🥞', n: 'آرد', g: 50, cal: 180, p: 5, f: 1, c: 38, fi: 1.5 }, { id: 'm1_9_1', e: '🍳', n: 'تخم مرغ (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm1_9_2', e: '🍯', n: 'عسل', g: 21, cal: 64, p: 0.1, f: 0, c: 17, fi: 0 }] }, { name: 'کتو: املت اسفناج و پنیر', id: 'm1_k0', isKeto: true, emoji: '🥬', ingredients: [{ id: 'm1_k0_0', e: '🍳', n: 'تخم مرغ (۳ عدد)', g: 150, cal: 233, p: 19.5, f: 16.5, c: 1.7, fi: 0 }, { id: 'm1_k0_1', e: '🥬', n: 'اسفناج', g: 100, cal: 23, p: 2.9, f: 0.4, c: 3.6, fi: 2.2 }, { id: 'm1_k0_2', e: '🧀', n: 'پنیر خامه‌ای', g: 50, cal: 107, p: 3, f: 10, c: 1.5, fi: 0 }, { id: 'm1_k0_3', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }] }, { name: 'کتو: املت با پنیر موزارلا', id: 'm1_k1', isKeto: true, emoji: '🧀', ingredients: [{ id: 'm1_k1_0', e: '🍳', n: 'تخم مرغ (۳ عدد)', g: 150, cal: 233, p: 19.5, f: 16.5, c: 1.7, fi: 0 }, { id: 'm1_k1_1', e: '🧀', n: 'پنیر موزارلا', g: 60, cal: 140, p: 12, f: 9, c: 2, fi: 0 }, { id: 'm1_k1_2', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }] }, { name: 'کتو: ماست پرچرب و آجیل', id: 'm1_k2', isKeto: true, emoji: '🌰', ingredients: [{ id: 'm1_k2_0', e: '🥛', n: 'ماست پرچرب', g: 200, cal: 190, p: 18, f: 10, c: 6, fi: 0 }, { id: 'm1_k2_1', e: '🌰', n: 'مخلوط آجیل', g: 30, cal: 180, p: 6, f: 15, c: 6, fi: 3 }] }, { name: 'کتو: کره و پنیر خامه‌ای', id: 'm1_k3', isKeto: true, emoji: '🧈', ingredients: [{ id: 'm1_k3_0', e: '🧈', n: 'کره', g: 20, cal: 144, p: 0.2, f: 16.2, c: 0, fi: 0 }, { id: 'm1_k3_1', e: '🧀', n: 'پنیر خامه‌ای', g: 60, cal: 128, p: 3.6, f: 12.6, c: 2.2, fi: 0 }] }, { name: 'کتو: نیمرو و بیکن', id: 'm1_k4', isKeto: true, emoji: '🥓', ingredients: [{ id: 'm1_k4_0', e: '🍳', n: 'تخم مرغ (۳ عدد)', g: 150, cal: 233, p: 19.5, f: 16.5, c: 1.7, fi: 0 }, { id: 'm1_k4_1', e: '🥓', n: 'بیکن', g: 50, cal: 220, p: 18, f: 16, c: 1, fi: 0 }, { id: 'm1_k4_2', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }] }, { name: 'کتو: تخم مرغ و آووکادو', id: 'm1_k5', isKeto: true, emoji: '🥑', ingredients: [{ id: 'm1_k5_0', e: '🍳', n: 'تخم مرغ (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm1_k5_1', e: '🥑', n: 'آووکادو', g: 100, cal: 160, p: 2, f: 15, c: 9, fi: 7 }] }, { name: 'کتو: سوسیس و تخم مرغ', id: 'm1_k6', isKeto: true, emoji: '🌭', ingredients: [{ id: 'm1_k6_0', e: '🍳', n: 'تخم مرغ (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm1_k6_1', e: '🌭', n: 'سوسیس شکاری', g: 100, cal: 300, p: 12, f: 28, c: 2, fi: 0 }] }, { name: 'کتو: پنکیک آرد بادام', id: 'm1_k7', isKeto: true, emoji: '🥞', ingredients: [{ id: 'm1_k7_0', e: '🥜', n: 'آرد بادام', g: 50, cal: 290, p: 10.5, f: 25, c: 10, fi: 5 }, { id: 'm1_k7_1', e: '🍳', n: 'تخم مرغ (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm1_k7_2', e: '🧈', n: 'کره', g: 15, cal: 108, p: 0.1, f: 12.2, c: 0, fi: 0 }] } ],
        dinner: [ { name: 'چلو کباب کوبیده', id: 'm2_0', emoji: '🍢', ingredients: [{ id: 'm2_0_0', e: '🍢', n: 'کباب کوبیده', g: 160, cal: 450, p: 35, f: 32, c: 5, fi: 1 }, { id: 'm2_0_1', e: '🍚', n: 'برنج ایرانی', g: 320, cal: 416, p: 8, f: 1, c: 90, fi: 1.5 }, { id: 'm2_0_2', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }, { id: 'm2_0_3', e: '🍅', n: 'گوجه کبابی', g: 100, cal: 30, p: 1, f: 0.2, c: 7, fi: 1.5 }] }, { name: 'چلو جوجه کباب', id: 'm2_1', emoji: '🐔', ingredients: [{ id: 'm2_1_0', e: '🐔', n: 'جوجه کباب سینه', g: 165, cal: 270, p: 50, f: 6, c: 0, fi: 0 }, { id: 'm2_1_1', e: '🍚', n: 'برنج ایرانی', g: 350, cal: 455, p: 9, f: 1, c: 98, fi: 1.8 }, { id: 'm2_1_2', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }, { id: 'm2_1_3', e: '🍅', n: 'گوجه کبابی', g: 100, cal: 30, p: 1, f: 0.2, c: 7, fi: 1.5 }] }, { name: 'لازانیا گوشت', id: 'm2_2', emoji: '🍝', ingredients: [{ id: 'm2_2_0', e: '🍝', n: 'ورق لازانیا', g: 100, cal: 370, p: 12, f: 3, c: 75, fi: 4 }, { id: 'm2_2_1', e: '🥩', n: 'گوشت چرخ کرده', g: 150, cal: 380, p: 25, f: 30, c: 0, fi: 0 }, { id: 'm2_2_2', e: '🧀', n: 'پنیر پیتزا', g: 150, cal: 450, p: 38, f: 30, c: 3, fi: 0 }] }, { name: 'پیتزا پپرونی', id: 'm2_3', emoji: '🍕', ingredients: [{ id: 'm2_3_0', e: '🍕', n: 'خمیر پیتزا', g: 150, cal: 400, p: 15, f: 8, c: 70, fi: 4 }, { id: 'm2_3_1', e: '🍖', n: 'پپرونی', g: 80, cal: 400, p: 18, f: 35, c: 2, fi: 0 }, { id: 'm2_3_2', e: '🧀', n: 'پنیر پیتزا', g: 100, cal: 300, p: 25, f: 20, c: 2, fi: 0 }, { id: 'm2_3_3', e: '🍅', n: 'سس و قارچ', g: 70, cal: 80, p: 2, f: 4, c: 8, fi: 1.5 }] }, { name: 'کشک بادمجان', id: 'm2_4', emoji: '🍆', ingredients: [{ id: 'm2_4_0', e: '🍆', n: 'بادمجان کبابی', g: 200, cal: 70, p: 2, f: 0.4, c: 16, fi: 6 }, { id: 'm2_4_1', e: '🥣', n: 'کشک', g: 50, cal: 55, p: 8, f: 1, c: 4, fi: 0 }, { id: 'm2_4_2', e: '🧈', n: 'کره', g: 10, cal: 72, p: 0.1, f: 8.1, c: 0, fi: 0 }, { id: 'm2_4_3', e: '🌰', n: 'گردو', g: 10, cal: 65, p: 1.5, f: 6.5, c: 1.4, fi: 0.7 }, { id: 'm2_4_4', e: '🍞', n: 'نان سنگک', g: 50, cal: 125, p: 5, f: 0.6, c: 27.5, fi: 3.7 }] }, { name: 'چلو خورشت قورمه سبزی', id: 'm2_5', emoji: '🍲', ingredients: [{ id: 'm2_5_0', e: '🍲', n: 'خورشت قورمه سبزی', g: 250, cal: 450, p: 25, f: 30, c: 20, fi: 8 }, { id: 'm2_5_1', e: '🍚', n: 'برنج ایرانی', g: 300, cal: 390, p: 7.5, f: 0.9, c: 84, fi: 1.2 }] }, { name: 'چلو خورشت قیمه', id: 'm2_6', emoji: '🍛', ingredients: [{ id: 'm2_6_0', e: '🍛', n: 'خورشت قیمه', g: 250, cal: 400, p: 22, f: 25, c: 22, fi: 7 }, { id: 'm2_6_1', e: '🍟', n: 'سیب زمینی سرخ کرده', g: 50, cal: 150, p: 2, f: 7, c: 18, fi: 2 }, { id: 'm2_6_2', e: '🍚', n: 'برنج ایرانی', g: 300, cal: 390, p: 7.5, f: 0.9, c: 84, fi: 1.2 }] }, { name: 'سالاد الویه', id: 'm2_7', emoji: '🥔', ingredients: [{ id: 'm2_7_0', e: '🥔', n: 'سیب‌زمینی پخته', g: 150, cal: 130, p: 3, f: 0.2, c: 30, fi: 3 }, { id: 'm2_7_1', e: '🥚', n: 'تخم مرغ آب‌پز (۲ عدد)', g: 100, cal: 155, p: 13, f: 11, c: 1.1, fi: 0 }, { id: 'm2_7_2', e: '🐔', n: 'سینه مرغ', g: 80, cal: 132, p: 25, f: 3, c: 0, fi: 0}, { id: 'm2_7_3', e: '🥣', n: 'سس مایونز', g: 50, cal: 350, p: 0.5, f: 38, c: 1.5, fi: 0 }, { id: 'm2_7_4', e: '🍞', n: 'نان', g: 50, cal: 125, p: 5, f: 0.6, c: 27.5, fi: 3.7 }] }, { name: 'آش رشته', id: 'm2_8', emoji: '🍲', ingredients: [{ id: 'm2_8_0', e: '🍲', n: 'رشته آش', g: 100, cal: 350, p: 12, f: 1.5, c: 70, fi: 5 }, { id: 'm2_8_1', e: '🥣', n: 'حبوبات پخته', g: 200, cal: 260, p: 16, f: 1, c: 48, fi: 15 }, { id: 'm2_8_2', e: '🌿', n: 'سبزی آش', g: 100, cal: 30, p: 2, f: 0.5, c: 5, fi: 3 }, { id: 'm2_8_3', e: '🥣', n: 'کشک', g: 30, cal: 33, p: 4.8, f: 0.6, c: 2.4, fi: 0 }, { id: 'm2_8_4', e: '🧅', n: 'پیاز داغ', g: 10, cal: 60, p: 0.2, f: 6, c: 2, fi: 0.3 }] }, { name: 'کتو: خوراک کدو و پنیر', id: 'm2_k0', isKeto: true, emoji: '🥒', ingredients: [{ id: 'm2_k0_0', e: '🥒', n: 'کدو سبز', g: 300, cal: 60, p: 3.6, f: 0.9, c: 9.3, fi: 3 }, { id: 'm2_k0_1', e: '🧀', n: 'پنیر خامه‌ای', g: 100, cal: 213, p: 6, f: 21, c: 3, fi: 0 }, { id: 'm2_k0_2', e: '🧈', n: 'کره', g: 15, cal: 108, p: 0.1, f: 12.2, c: 0, fi: 0 }, { id: 'm2_k0_3', e: '🌰', n: 'گردو', g: 15, cal: 98, p: 2.3, f: 9.8, c: 2.1, fi: 1 }] }, { name: 'کتو: مرغ با سس خامه و قارچ', id: 'm2_k1', isKeto: true, emoji: '🍗', ingredients: [{ id: 'm2_k1_0', e: '🐔', n: 'سینه مرغ', g: 200, cal: 330, p: 62, f: 7.2, c: 0, fi: 0 }, { id: 'm2_k1_1', e: '🍄', n: 'قارچ', g: 150, cal: 33, p: 4.5, f: 0.5, c: 5, fi: 1.5 }, { id: 'm2_k1_2', e: '🥥', n: 'خامه پرچرب', g: 100, cal: 340, p: 2, f: 36, c: 3, fi: 0 }, { id: 'm2_k1_3', e: '🧈', n: 'کره', g: 15, cal: 108, p: 0.1, f: 12.2, c: 0, fi: 0 }] }, { name: 'کتو: ماهی سالمون و مارچوبه', id: 'm2_k2', isKeto: true, emoji: '🐟', ingredients: [{ id: 'm2_k2_0', e: '🐟', n: 'فیله سالمون', g: 200, cal: 416, p: 40, f: 28, c: 0, fi: 0 }, { id: 'm2_k2_1', e: '🌿', n: 'مارچوبه', g: 200, cal: 40, p: 4.4, f: 0.4, c: 7.8, fi: 4.2 }, { id: 'm2_k2_2', e: '🍋', n: 'روغن زیتون', g: 20, cal: 177, p: 0, f: 20, c: 0, fi: 0 }] }, { name: 'کتو: پیتزا با خمیر گل کلم', id: 'm2_k3', isKeto: true, emoji: '🍕', ingredients: [{ id: 'm2_k3_0', e: '🥦', n: 'خمیر گل کلم', g: 250, cal: 150, p: 15, f: 7, c: 12, fi: 8 }, { id: 'm2_k3_1', e: '🍖', n: 'پپرونی', g: 80, cal: 400, p: 18, f: 35, c: 2, fi: 0 }, { id: 'm2_k3_2', e: '🧀', n: 'پنیر موزارلا', g: 120, cal: 340, p: 30, f: 24, c: 3, fi: 0 }] }, ],
    };
    let state = {};
    const model = {
        initializeState() { state = { user: { weight: 93, weeklyLoss: 1.0 }, metrics: {}, meals: {} }; [...DB.fixedSnacks, ...DB.superSatiety, ...DB.breakfast, ...DB.dinner].forEach(mealTpl => { state.meals[mealTpl.id] = { id: mealTpl.id, type: mealTpl.id.split('_')[0], isSelected: false, isMealLocked: false, isOpen: mealTpl.id.startsWith('fs'), ingredients: mealTpl.ingredients.map(ingTpl => ({ id: ingTpl.id, isEnabled: !ingTpl.defaultOff, isLocked: false, grams: ingTpl.g })) }; }); },
        updateAndCalculate() { const { weight, weeklyLoss } = state.user; const bmr = Math.round((10 * weight) + (6.25 * 175) - (5 * 28) + 5); const tdee = Math.round(bmr * 1.375); const dailyDeficit = Math.round(weeklyLoss * 7700 / 7); const targetCalories = tdee - dailyDeficit; state.metrics = { bmr, tdee, dailyDeficit, targetCalories, bmi: (weight / ((175 / 100) ** 2)).toFixed(1) }; this.rebalanceMeals(); },
        rebalanceMeals() {
            const isManualMode = Object.values(state.meals).some(m => m.isSelected && m.type !== 'fs');
            if(isManualMode) return; 
            let fixedCals = 0;
            Object.values(state.meals).forEach(meal => { if (meal.type === 'fs') fixedCals += this.getMealData(meal.id).totalCalories; });
            const availableCals = state.metrics.targetCalories - fixedCals;
            const targetCalPerMeal = (availableCals > 0) ? availableCals / 2 : 500;
            Object.values(state.meals).forEach(meal => { if (meal.type === 'fs' || meal.isMealLocked) return; this.scaleMeal(meal.id, targetCalPerMeal); });
        },
        scaleMeal(mealId, targetCalories) { const mealTpl = this.getMealTemplate(mealId); const mealState = state.meals[mealId]; let originalTotalCal = 0; mealTpl.ingredients.forEach(ing => { if (!ing.defaultOff) originalTotalCal += ing.cal; }); if (originalTotalCal > 0) { const scaleFactor = targetCalories / originalTotalCal; mealState.ingredients.forEach((ingState, i) => { ingState.grams = mealTpl.ingredients[i].g * scaleFactor; }); } },
        distributeCalorieChange(mealId, changedIngId, newGrams) {
            const mealState = state.meals[mealId]; const mealTpl = this.getMealTemplate(mealId); const changedIngIndex = mealTpl.ingredients.findIndex(i => i.id === changedIngId); const changedIngTpl = mealTpl.ingredients[changedIngIndex]; const changedIngState = mealState.ingredients[changedIngIndex];
            if (!changedIngTpl || changedIngTpl.g === 0) return;
            const oldGrams = changedIngState.grams; const calPerGram = changedIngTpl.cal / changedIngTpl.g; const calorieDifference = (newGrams - oldGrams) * calPerGram;
            changedIngState.grams = newGrams;
            const adjustableIngs = []; let totalAdjustableCal = 0;
            mealState.ingredients.forEach((ing, i) => { if (ing.id === changedIngId || !ing.isEnabled || ing.isLocked) return; const ingTpl = mealTpl.ingredients[i]; if (ingTpl.g === 0) return; const currentCal = (ingTpl.cal / ingTpl.g) * ing.grams; adjustableIngs.push({ state: ing, tpl: ingTpl, cal: currentCal }); totalAdjustableCal += currentCal; });
            if (totalAdjustableCal > 0 && Math.abs(calorieDifference) > 0) { adjustableIngs.forEach(item => { const proportion = item.cal / totalAdjustableCal; const calAdjustment = calorieDifference * proportion; if (item.tpl.cal === 0 || item.tpl.g === 0) return; const gramAdjustment = calAdjustment / (item.tpl.cal / item.tpl.g); item.state.grams = Math.max(0, item.state.grams - gramAdjustment); }); }
        },
        getMealTemplate(mealId) { const type = mealId.split('_')[0]; const dbKeyMap = { fs: 'fixedSnacks', ss: 'superSatiety', m1: 'breakfast', m2: 'dinner' }; return DB[dbKeyMap[type]].find(m => m.id === mealId); },
        getMealData(mealId) { const mealState = state.meals[mealId]; const mealTpl = this.getMealTemplate(mealId); let totals = { totalCalories: 0, p: 0, f: 0, c: 0, fi: 0 }; mealState.ingredients.forEach((ingState, i) => { if (!ingState.isEnabled) return; const ingTpl = mealTpl.ingredients[i]; if (!ingTpl || ingTpl.g === 0) return; const gFactor = ingState.grams / ingTpl.g; totals.totalCalories += (ingTpl.cal || 0) * gFactor; totals.p += (ingTpl.p || 0) * gFactor; totals.f += (ingTpl.f || 0) * gFactor; totals.c += (ingTpl.c || 0) * gFactor; totals.fi += (ingTpl.fi || 0) * gFactor; }); return { ...totals, ...mealTpl, state: mealState }; },
        getIngredientMacros(mealId, ingId) { const mealState = state.meals[mealId]; const mealTpl = this.getMealTemplate(mealId); const ingState = mealState.ingredients.find(i => i.id === ingId); const ingTpl = mealTpl.ingredients.find(i => i.id === ingId); if (!ingState || !ingState.isEnabled || !ingTpl || ingTpl.g === 0) return { p: 0, f: 0, c: 0, fi: 0 }; const gFactor = ingState.grams / ingTpl.g; return { p: (ingTpl.p || 0) * gFactor, f: (ingTpl.f || 0) * gFactor, c: (ingTpl.c || 0) * gFactor, fi: (ingTpl.fi || 0) * gFactor }; },
        getDailySummary() {
            let totals = { p: 0, f: 0, c: 0, fi: 0, totalCalories: 0 }; const selectedMeals = [];
            Object.values(state.meals).forEach(meal => { if(meal.isSelected || meal.type === 'fs') { const data = this.getMealData(meal.id); totals.p += data.p; totals.f += data.f; totals.c += data.c; totals.fi += data.fi; totals.totalCalories += data.totalCalories; selectedMeals.push(data); } });
            const calFromP = totals.p * 4; const calFromF = totals.f * 9; const calFromC = totals.c * 4; const totalMacroCals = calFromP + calFromF + calFromC;
            const percentages = totalMacroCals > 0 ? { p: (calFromP / totalMacroCals) * 100, f: (calFromF / totalMacroCals) * 100, c: (calFromC / totalMacroCals) * 100, } : { p: 0, f: 0, c: 0 };
            return { totals, percentages, selectedMeals };
        }
    };
    const view = {
        render() { this.renderDashboard(); this.renderSummaryBar(); Object.keys(state.meals).forEach(mealId => this.renderMealCard(mealId)); this.renderDailySummary(); },
        createInitialHTML() {
            document.getElementById('app-container').innerHTML = `<section><h2 class="text-2xl font-bold mb-4 border-b-2 pb-2">🥤 وعده‌های ثابت</h2><div id="fs-container" class="space-y-4"></div></section><section class="mt-8"><h2 class="text-2xl font-bold mb-4 border-b-2 pb-2 text-amber-600 border-amber-400">⭐ وعده‌های فوق سیرکننده</h2><div id="ss-container" class="space-y-4"></div></section><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8"><section><h2 class="text-2xl font-bold mb-4 border-b-2 pb-2">🌅 وعده اول</h2><div id="m1-container" class="space-y-4"></div></section><section><h2 class="text-2xl font-bold mb-4 border-b-2 pb-2">🍛 وعده دوم</h2><div id="m2-container" class="space-y-4"></div></section></div>`;
            [...DB.fixedSnacks, ...DB.superSatiety, ...DB.breakfast, ...DB.dinner].forEach(mealTpl => { document.getElementById(`${mealTpl.id.split('_')[0]}-container`).innerHTML += this.getCardHTML(mealTpl); });
        },
        getCardHTML(mealTpl) {
            const isFixed = mealTpl.id.startsWith('fs');
            const ingredientHTML = mealTpl.ingredients.map(ing => `<li data-ingredient-id="${ing.id}" class="text-sm flex flex-wrap justify-between items-center py-2 border-b last:border-b-0 gap-2"><div class="flex items-center"><span class="lock-icon ingredient-lock-icon mr-2">🔒</span><input type="checkbox" id="toggle-${ing.id}" class="toggle-checkbox hidden"><label for="toggle-${ing.id}" class="toggle-label relative w-10 h-5 rounded-full cursor-pointer mr-3"><span class="toggle-dot absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform"></span></label><span>${ing.e} ${ing.n}</span></div><div class="flex items-center"><span class="ingredient-macros"></span><input type="number" class="gram-input"><span>گرم</span></div></li>`).join('');
            const header = isFixed ? `<h4 class="text-lg font-bold">${mealTpl.emoji} ${mealTpl.name}</h4>` : `<div class="summary-view cursor-pointer"><div class="flex justify-between items-start"><div class="flex-grow"><h4 class="text-lg font-bold flex items-center">${mealTpl.isKeto ? '<span class="keto-tag">کتو</span>':''}${mealTpl.emoji} ${mealTpl.name}</h4><p class="meal-macros text-sm text-gray-500"></p></div><div class="flex items-center gap-2"><input type="number" class="calorie-input text-blue-600"><span class="lock-icon meal-lock-icon">🔒</span></div></div><div class="toggle-details text-xs text-blue-500 mt-2 font-semibold">مشاهده جزئیات</div></div>`;
            return `<div id="${mealTpl.id}" class="${isFixed ? 'fixed-item-card':'meal-card'} bg-white p-4 rounded-xl shadow-lg ${mealTpl.isKeto ? 'satiety-card': ''}">${header}<div class="ingredient-list mt-2 pt-2 border-t"><ul>${ingredientHTML}</ul></div></div>`;
        },
        renderDashboard() { const { bmi, bmr, tdee, dailyDeficit, targetCalories } = state.metrics; document.getElementById('live-dashboard').innerHTML = `<div class="bg-white p-3 rounded-xl shadow-md"><p class="font-semibold text-gray-500 text-xs sm:text-sm">BMI</p><p class="text-xl sm:text-2xl font-bold text-blue-600">${bmi || 'N/A'}</p></div><div class="bg-white p-3 rounded-xl shadow-md"><p class="font-semibold text-gray-500 text-xs sm:text-sm">BMR</p><p class="text-xl sm:text-2xl font-bold text-blue-600">${bmr || 0}</p></div><div class="bg-white p-3 rounded-xl shadow-md"><p class="font-semibold text-gray-500 text-xs sm:text-sm">TDEE</p><p class="text-xl sm:text-2xl font-bold text-blue-600">${tdee || 0}</p></div><div class="bg-white p-3 rounded-xl shadow-md col-span-1 sm:col-auto"><p class="font-semibold text-gray-500 text-xs sm:text-sm">کسری کالری</p><p class="text-xl sm:text-2xl font-bold text-red-500">-${dailyDeficit || 0}</p></div><div class="bg-white p-3 rounded-xl shadow-md col-span-2 sm:col-span-3 lg:col-span-1 border-2 border-green-500"><p class="font-semibold text-gray-500 text-xs sm:text-sm">کالری هدف</p><p class="text-2xl sm:text-3xl font-bold text-green-600">~${targetCalories || 0}</p></div>`; },
        renderSummaryBar() {
            const { totals } = model.getDailySummary(); const target = state.metrics.targetCalories || 0; const percent = target > 0 ? Math.min(100, (totals.totalCalories / target) * 100) : 0;
            let barClass = 'bg-yellow-300'; if (totals.totalCalories > target + 50) barClass = 'bg-red-500'; else if (totals.totalCalories >= target - 50) barClass = 'bg-green-500';
            document.getElementById('summary-bar').innerHTML = `<div class="flex flex-col sm:flex-row items-center justify-between gap-3"><div class="flex items-center gap-4"><h2 class="text-xl font-bold">خلاصه روزانه</h2><div class="flex items-center gap-2 text-lg"><span>کل:</span><span class="font-bold text-2xl bg-white text-blue-700 px-3 py-1 rounded-md">${Math.round(totals.totalCalories)}</span><span>/ ${target}</span></div></div><button id="printBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">ذخیره PDF</button></div><div class="w-full bg-blue-400 rounded-full h-2.5 mt-3"><div class="${barClass} h-2.5 rounded-full" style="width: ${percent}%"></div></div>`;
        },
        renderMealCard(mealId) {
            const el = document.getElementById(mealId); const data = model.getMealData(mealId);
            el.classList.toggle('selected', data.state.isSelected); el.classList.toggle('open', data.state.isOpen);
            if (!data.id.startsWith('fs')) {
                el.querySelector('.meal-lock-icon').classList.toggle('locked', data.state.isMealLocked); el.querySelector('.calorie-input').value = Math.round(data.totalCalories);
                el.querySelector('.meal-macros').innerHTML = `P: ${data.p.toFixed(1)} | F: ${data.f.toFixed(1)} | C: ${data.c.toFixed(1)} | Fi: ${data.fi.toFixed(1)}`;
            }
            data.state.ingredients.forEach(ingState => {
                const ingEl = el.querySelector(`[data-ingredient-id="${ingState.id}"]`);
                ingEl.querySelector('.ingredient-lock-icon').classList.toggle('locked', ingState.isLocked);
                ingEl.querySelector('.toggle-checkbox').checked = ingState.isEnabled;
                ingEl.querySelector('.gram-input').value = Math.round(ingState.grams);
                const macros = model.getIngredientMacros(mealId, ingState.id);
                ingEl.querySelector('.ingredient-macros').innerHTML = `P:${macros.p.toFixed(1)} F:${macros.f.toFixed(1)} C:${macros.c.toFixed(1)} Fi:${macros.fi.toFixed(1)}`;
            });
        },
        renderDailySummary() {
            const { totals, percentages, selectedMeals } = model.getDailySummary();
            const selectedMealsHTML = selectedMeals.length > 0 ? selectedMeals.map(m => `<li class="flex justify-between"><span>${m.emoji} ${m.name}</span> <span class="font-semibold">${Math.round(m.totalCalories)} kcal</span></li>`).join('') : '<li>هیچ وعده‌ای انتخاب نشده است.</li>';
            document.getElementById('daily-summary-section').innerHTML = `<div class="bg-white p-4 md:p-6 rounded-xl shadow-lg"><h2 class="text-xl md:text-2xl font-bold mb-4">خلاصه مواد مغذی روزانه</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><h3 class="font-semibold">وعده‌های انتخابی:</h3><ul class="space-y-1 text-gray-700">${selectedMealsHTML}</ul></div><div><h3 class="font-semibold mt-4">مجموع کل:</h3><p class="text-sm md:text-base">پروتئین: ${totals.p.toFixed(1)}g | چربی: ${totals.f.toFixed(1)}g | کربوهیدرات: ${totals.c.toFixed(1)}g | فیبر: ${totals.fi.toFixed(1)}g</p></div></div><div><h3 class="font-semibold mb-2">درصد کالری از ماکرونوترینت‌ها:</h3><div class="space-y-3"><div class="w-full"><div class="flex justify-between mb-1"><span class="text-base font-medium text-blue-700">پروتئین</span><span class="text-sm font-medium text-blue-700">${percentages.p.toFixed(1)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentages.p}%"></div></div></div><div class="w-full"><div class="flex justify-between mb-1"><span class="text-base font-medium text-red-700">چربی</span><span class="text-sm font-medium text-red-700">${percentages.f.toFixed(1)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-red-600 h-2.5 rounded-full" style="width: ${percentages.f}%"></div></div></div><div class="w-full"><div class="flex justify-between mb-1"><span class="text-base font-medium text-green-700">کربوهیدرات</span><span class="text-sm font-medium text-green-700">${percentages.c.toFixed(1)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-green-600 h-2.5 rounded-full" style="width: ${percentages.c}%"></div></div></div></div></div></div></div>`;
        },
    };
    
    const controller = {
        init() {
            model.initializeState(); view.createInitialHTML();
            document.getElementById('currentWeight').addEventListener('input', this.handleUserInputChange);
            document.getElementById('targetWeeklyLoss').addEventListener('input', this.handleUserInputChange);
            document.getElementById('app-container').addEventListener('click', this.handleCardClick.bind(this));
            document.getElementById('app-container').addEventListener('input', this.handleCardInput.bind(this));
            document.getElementById('summary-bar').addEventListener('click', e => { if (e.target.id === 'printBtn') window.print(); });
            model.updateAndCalculate(); view.render();
        },
        handleUserInputChange() { state.user.weight = parseFloat(document.getElementById('currentWeight').value) || 0; state.user.weeklyLoss = parseFloat(document.getElementById('targetWeeklyLoss').value) || 0; model.updateAndCalculate(); view.render(); },
        handleCardClick(e) {
            const mealEl = e.target.closest('.meal-card, .fixed-item-card'); if (!mealEl) return;
            const mealId = mealEl.id; const mealState = state.meals[mealId];
            if (e.target.closest('.summary-view') && !e.target.closest('.lock-icon, input')) {
                e.stopPropagation();
                if (mealState.type !== 'fs') { mealState.isSelected = !mealState.isSelected; }
                mealState.isOpen = !mealState.isOpen;
            } else if (e.target.closest('.meal-lock-icon')) { e.stopPropagation(); mealState.isMealLocked = !mealState.isMealLocked;
            } else if (e.target.closest('.ingredient-lock-icon')) { e.stopPropagation(); mealState.ingredients.find(i=>i.id === e.target.closest('li').dataset.ingredientId).isLocked = !mealState.ingredients.find(i=>i.id === e.target.closest('li').dataset.ingredientId).isLocked;
            }
            model.updateAndCalculate(); view.render();
        },
        handleCardInput(e) {
            const mealEl = e.target.closest('.meal-card, .fixed-item-card'); if (!mealEl) return;
            const mealId = mealEl.id; const mealState = state.meals[mealId];
            if (e.target.matches('.gram-input')) {
                const ingId = e.target.closest('li').dataset.ingredientId; const newGrams = parseFloat(e.target.value) || 0;
                if(mealState.isMealLocked) { model.distributeCalorieChange(mealId, ingId, newGrams); } else { mealState.ingredients.find(i => i.id === ingId).grams = newGrams; }
            } else if (e.target.matches('.calorie-input')) { model.scaleMeal(mealId, parseFloat(e.target.value) || 0);
            } else if (e.target.matches('.toggle-checkbox')) { mealState.ingredients.find(i => i.id === e.target.closest('li').dataset.ingredientId).isEnabled = e.target.checked; }
            model.updateAndCalculate(); view.render();
        }
    };
    
    controller.init();
})();
</script>

</body>
</html>
